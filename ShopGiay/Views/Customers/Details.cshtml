@model ShopGiay.Models.Mathang

@{
    ViewData["Title"] = @Model.Ten;
    // GIẢ ĐỊNH: Các ViewBag này được Controller cung cấp
    var averageRating = ViewBag.AverageRating as double? ?? 0.0;
    var reviewCount = ViewBag.ReviewCount as int? ?? 0;
    var hasReviewed = ViewBag.HasReviewed as bool? ?? false;
    // Lấy danh sách đánh giá từ ViewBag
    var danhSachDanhGia = ViewBag.DanhSachDanhGia as List<ShopGiay.Models.Danhgia> ?? new List<ShopGiay.Models.Danhgia>();
    var danhSachBienThe = ViewBag.BienThe as List<ShopGiay.Models.Tonkho> ?? new List<ShopGiay.Models.Tonkho>();
    // Lượt mua (ĐÃ THÊM để tăng Social Proof)
    var luotMua = ViewBag.LuotMua as int? ?? 0;

    // Tạo danh sách màu và size độc lập cho combobox
    var availableColors = danhSachBienThe.Select(bt => bt.MaMsNavigation.Ten).Distinct().ToList();
    var availableSizes = danhSachBienThe.Select(bt => bt.MaKcNavigation.GiaTriKc).Distinct().ToList();
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* CSS Tùy chỉnh cho Trang Chi tiết */
    .product-details-card {
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        padding: 40px;
        background: #fff;
    }

    .product-image-container {
        position: sticky;
        top: 20px;
        padding: 20px;
        border-radius: 12px;
        background-color: #f7f7f7;
    }

        .product-image-container img {
            border-radius: 10px;
            object-fit: cover;
            width: 100%;
            height: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

    .price-original-details {
        font-size: 1.25rem;
        color: #999;
        text-decoration: line-through;
        margin-right: 10px;
    }

    .price-sale-details {
        font-size: 2.5rem;
        color: #e74c3c;
        font-weight: 900;
        line-height: 1;
    }

    .rating-star-group .bi-star-fill {
        color: gold;
        font-size: 1.2rem;
    }

    .rating-star-group .bi-star {
        color: #ccc;
        font-size: 1.2rem;
    }

    .rating-star-group .bi-star-half {
        color: gold;
        font-size: 1.2rem;
    }


    .review-box {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .review-user-name {
        font-weight: 700;
        color: #1e81b0;
    }
</style>

<div class="container mt-5">
    <!-- PRODUCT DETAIL SECTION -->
    <div class="row product-details-card mb-5">

        <!-- Cột 1: Hình ảnh -->
        <div class="col-lg-5">
            <div class="product-image-container">
                <img src="~/images/products/@Model.HinhAnh" alt="@Model.Ten" class="img-fluid" />
            </div>
        </div>

        <!-- Cột 2: Thông tin chi tiết -->
        <div class="col-lg-7">
            <h1 class="fw-bold mb-3 text-dark">@Model.Ten</h1>

            <!-- Rating & Price -->
            <div class="d-flex align-items-center mb-4">
                <!-- Đánh giá trung bình -->
                <div class="rating-star-group me-4">
                    @{
                        // Hàm helper để render sao (giả định)
                        Func<double, int, string> renderStars = (rating, total) =>
                        {
                            var stars = "";
                            for (int i = 1; i <= 5; i++)
                            {
                                if (i <= (int)rating) stars += "<i class='bi bi-star-fill'></i>";
                                else if (i - rating < 1 && i - rating > 0 && i > rating) stars += "<i class='bi bi-star-half'></i>";
                                else stars += "<i class='bi bi-star'></i>";
                            }
                            return stars;
                        };
                    }
                    <span class="text-warning">
                        @Html.Raw(renderStars(averageRating, 5))
                    </span>
                    <span class="text-secondary ms-2">(@reviewCount đánh giá)</span>
                </div>

            </div>

            <div class="d-flex align-items-end mb-4">
                @if (Model.GiaGoc.HasValue && Model.GiaGoc > Model.GiaBan)
                {
                    <span class="price-original-details">@string.Format("{0:N0}₫", Model.GiaGoc)</span>
                }
                <span class="price-sale-details">@string.Format("{0:N0}₫", Model.GiaBan)</span>
            </div>

            <p class="text-muted border-bottom pb-3">
                @Model.MoTa
            </p>

            <!-- Thông tin nổi bật (CẬP NHẬT LƯỢT MUA) -->
            <div class="mb-4">
                <p><strong><i class="bi bi-tag-fill me-2 text-primary"></i>Loại giày:</strong> @Model.MaLgNavigation.Ten</p>
                <p><strong><i class="bi bi-building-fill me-2 text-primary"></i>Thương hiệu:</strong> @Model.MaThNavigation.Ten</p>
                <p><strong><i class="bi bi-eye-fill me-2 text-primary"></i>Lượt xem:</strong> @Model.LuotXem</p>
                <!-- HIỂN THỊ LƯỢT MUA HÀNG (SOCIAL PROOF) -->
                <p><strong><i class="bi bi-cart-check-fill me-2 text-success"></i>Đã bán:</strong> @luotMua sản phẩm</p>
            </div>

            <!-- Form Chọn Biến thể và Mua hàng -->
            <form asp-controller="Customers" asp-action="AddToCart" method="post">
                <input type="hidden" name="MaMh" value="@Model.MaMh" />

                <!-- Chọn màu -->
                <div class="mb-3">
                    <label for="colorSelect" class="form-label fw-bold">Chọn Màu:</label>
                    <select class="form-select" id="colorSelect" name="color">
                        @foreach (var color in availableColors)
                        {
                            <option value="@color">@color</option>
                        }
                    </select>
                </div>

                <!-- Chọn size -->
                <div class="mb-4">
                    <label for="sizeSelect" class="form-label fw-bold">Chọn Size:</label>
                    <select class="form-select" id="sizeSelect" name="size">
                        @foreach (var size in availableSizes)
                        {
                            <option value="@size">@size</option>
                        }
                    </select>
                </div>

                <!-- Nút Mua hàng và Quay lại -->
                <div class="d-flex gap-3">
                    <a asp-controller="Customers" asp-action="AddToCart" asp-route-id="@Model.MaMh" class="btn btn-outline-secondary btn-lg">
                        <i class="bi bi-bag-plus-fill"></i> Thêm vào giỏ hàng
                    </a>
                    <a asp-controller="Customers" asp-action="Index" class="btn btn-outline-secondary btn-lg">
                        <i class="bi bi-arrow-left me-2"></i> Trở về cửa hàng
                    </a>
                </div>
            </form>
        </div>
    </div>
    <!-- PHẦN ĐÁNH GIÁ SẢN PHẨM -->
    <h2 class="fw-bold mb-4 border-bottom pb-2"><i class="bi bi-chat-dots-fill me-2 text-primary"></i>Đánh Giá Khách Hàng (@reviewCount)</h2>

    <!-- 1. Form đánh giá (Chỉ hiển thị khi đã đăng nhập và chưa đánh giá) -->
    @if (User.Identity.IsAuthenticated)
    {
        @if (!hasReviewed)
        {
            <div class="review-box mb-5 bg-light">
                <h4 class="mb-3">Gửi đánh giá của bạn</h4>
                @* ĐÃ SỬA: Trỏ đến action GuiDanhGia *@
                <form asp-action="GuiDanhGia" asp-controller="Customers" method="post">
                    <input type="hidden" name="MaMh" value="@Model.MaMh" />

                    <!-- Chọn điểm -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Chọn điểm:</label>
                        <div>
                            @for (int i = 5; i >= 1; i--)
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Diem" id="rating@(i)" value="@i" required />
                                    <label class="form-check-label" for="rating@(i)">
                                        @i <i class="bi bi-star-fill text-warning"></i>
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Nội dung đánh giá -->
                    <div class="mb-3">
                        <label for="NoiDung" class="form-label fw-bold">Nội dung (tùy chọn):</label>
                        <textarea class="form-control" id="NoiDung" name="NoiDung" rows="3"></textarea>
                    </div>

                    <!-- CHECKBOX ẨN DANH -->
                    <div class="mb-3">
                        <div class="form-check">
                            @* Tên name là AnDanh để ánh xạ nếu dùng model Danhgia, hoặc để nhận giá trị trong HttpContext.Request.Form["AnDanh"] nếu dùng parameter list *@
                            <input class="form-check-input" type="checkbox" value="true" id="isAnonymous" name="AnDanh">
                            <label class="form-check-label" for="isAnonymous">
                                <i class="bi bi-mask me-1"></i> Đánh giá ẩn danh (Tên của bạn sẽ được ẩn)
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary"><i class="bi bi-send-fill me-2"></i>Gửi Đánh Giá</button>
                </form>
            </div>
        }
        else
        {
            <div class="alert alert-info mb-5" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>Bạn đã đánh giá sản phẩm này. Cảm ơn bạn!
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning mb-5" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>Vui lòng <a asp-controller="Customers" asp-action="Login" class="alert-link">Đăng nhập</a> để gửi đánh giá.
        </div>
    }


    <!-- 2. Danh sách đánh giá đã có -->
    <div class="review-list">
        @if (danhSachDanhGia.Any())
        {
            @foreach (var review in danhSachDanhGia.OrderByDescending(r => r.NgayDg))
            {
                <div class="review-box">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="review-user-name">
                            <i class="bi bi-person-circle me-1"></i>
                            @* Logic kiểm tra AnDanh *@
                            @if (review.IsAnonymous)
                            {
                                <span>Khách hàng ẩn danh</span>
                            }
                            else
                            {
                                <!-- Hiển thị tên thật nếu AnDanh là false -->
                                @(review.MaKhNavigation?.Ten ?? "Khách hàng")
                            }
                        </span>

                        <div class="rating-star-group">
                            @{
                                var reviewStars = "";
                                for (int i = 1; i <= 5; i++)
                                {
                                    reviewStars += (i <= review.Diem) ? "<i class='bi bi-star-fill'></i>" : "<i class='bi bi-star'></i>";
                                }
                            }
                            <span class="text-warning">
                                @Html.Raw(reviewStars)
                            </span>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(review.NoiDung))
                    {
                        <p class="text-dark">@review.NoiDung</p>
                    }

                    <small class="text-muted d-block text-end">Đánh giá vào: @review.NgayDg?.ToString("dd/MM/yyyy HH:mm")</small>
                </div>
            }
        }
        else
        {
            <p class="text-muted text-center py-3">Sản phẩm này chưa có đánh giá nào. Hãy là người đầu tiên!</p>
        }
    </div>

</div>